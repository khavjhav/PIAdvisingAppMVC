@model IEnumerable<PIAdvisingApp.ViewModels.PrcRptLcNotReceived>
@section Css {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <style>
        .tbody, td, th {
            padding: 2px !important;
            font-size: 11px !important;
        }

        .modal-backdrop {
            z-index: 10 !important
        }

        #added-table {
            height: 700px;
            overflow-y: scroll;
        }

            #added-table thead th,
            #added-table tbody tr,
            #added-table tfoot td {
                height: 7px;
                padding: 0;
            }

        /* Add this CSS code to your HTML file */
        .hide-column {
            display: none;
        }

        /* Add this CSS code for resizable columns */
        table.dataTable th,
        table.dataTable td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
           
        }

        .dataTables_wrapper .dataTables_columnResize {
            cursor: ew-resize;
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            z-index: 10;
        }

        .custom-row-height td {
            height: 5px;
        }
    </style>
}


<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="title">
                Advise PI Update
            </div>
          
        </div>
    </div>
</div>

<div class="container-fluid">

    <div class="row">
        <div class="col-md-7">
            <h2>Booking List</h2>


            <div class="main-card mb-8 card">
                <div class="card-body">

                    
                    <div>
                        
                            <div>
                                <button type="button" id="select-all-btn" class="btn btn-primary mr-2">Select All</button>
                                <button type="button" id="clear-all-btn" class="btn btn-secondary">Clear All</button>
                            </div>
                            @*<span class="text-right" style="font-size: 18px;">
                                Total Value: <span id="total-value"></span>
                            </span>*@
                      
                        <table id="datatable" class="mb-0 table table-bordered table-hover">
                            <thead class="th-top">
                                <tr>
                                    <th>SL</th>
                                    <th>
                                        Select
                                    </th>
                                    <th class="text-center">Booking No</th>
                                    <th class="text-center">Booking Date</th>

                                    <th class="text-center">PI Status</th>
                                    <th class="text-center">Customer Name</th>
                                    <th class="text-center">Representative Name</th>
                                    <th class="text-center">Booking Qty</th>
                                    <th class="text-center">Booking Value</th>
                                    @*<th class="text-center hide-column">Invoice Qty</th>
                    <th class="text-center">Invoice Value</th*@>
                                    @*<th class="text-center">LC Rcv Value</th>
                    <th class="text-center">LC Balance</th>*@
                                    @*<th class="text-center">PI Status</th>*@
                                    <th class="text-center">Retailer Name</th>
                                    <th class="text-center">Delivery (%)</th>
                                    <th class="text-center">Category Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ int rowNo = 1;}
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <input type="hidden" class="BookingNo" name="BookingNo" value="@item.BookingNo" />
                                        <input type="hidden" class="InvoiceQty" name="InvoiceQty" value="@item.InvoiceQty" />
                                        <input type="hidden" class="DelValue" name="DelValue" value="@item.BookingValue" />
                                        <td></td>
                                        <td class="text-center td-green">
                                            <input type="checkbox" class="selected" data-booking-no="@item.BookingNo" value="" />
                                        </td>
                                        <td class="text-left td-green">@item.BookingNo</td>
                                        <td class="text-left td-green">@item.BookingDate.ToString("d-MMM-yyyy")</td>
                                        <td class="text-center td-green">@item.ISPISEND</td>
                                        <td class="text-left td-green">@item.CustomerName</td>
                                        <td class="text-left td-green">@item.RepresentativeName</td>
                                        <td class="text-left td-green">@item.BookingQty</td>
                                        @MyHelpers.FinancialNumberRoundedTd(item.BookingValue, "td-green")
                                        @*<td class="text-left td-green">@item.InvoiceQty</td>
                        @MyHelpers.FinancialNumberRoundedTd(item.DelValue, "td-green")*@
                                        @*@MyHelpers.FinancialNumberRoundedTd(item.LCrcvValue, "td-green")
                        @MyHelpers.FinancialNumberRoundedTd(item.LCBalance, "td-green")*@
                                        @*<td class="text-left td-green">@item.ISPISEND</td>*@
                                        <td class="text-left td-green">@item.RetailerName</td>
                                        @MyHelpers.FinancialNumberTd(item.DlvPer, "td-pink", "", "%")
                                        @*<td class="td-yellow"></td>*@

                                        <td class="text-left td-green">@item.CategoryName</td>
                                    </tr>
                                    rowNo++;
                                }

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <h2 class="d-flex justify-content-between align-items-center">
                <span>Advised Bookings</span>
                <span class="text-right" style="font-size: 18px;">Total Value: <span id="total-value"></span></span>
            </h2>
            <div class="main-card mb-4 card">
                <div class="card-body" style="padding: 5px;">
                    @*<form id="added-bookings-form" method="post" action="@Url.Action("SaveApiData", "Sales")">*@
                    <table class="mb-0 table table-bordered table-hover" id="added-table" style="height: 700px; overflow-y: scroll;">
                        <thead>
                            <tr>
                                <th>SL</th>
                                <th class="text-center">Booking No.</th>
                                <th class="text-center">Booking No.</th>
                                <th class="text-center">Booking Date</th>
                                <th class="text-center">Category</th>
                                <th class="text-center">Customer</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><b id="total-value-footer"></b></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="submit-row d-flex justify-content-between align-items-center">
                        <input type="text" class="form-control remarks-input" placeholder="Remarks">
                        <button type="button" id="submit-btn" class="btn btn-primary">Submit</button>
                    </div>
                 
                </div>
            </div>


        </div>
    </div>
</div>

@section Modal {
    <div class="modal fade pi-advise-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content pi-modal-content">
            </div>
        </div>
    </div>
}
@section Scripts {
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>

    


    <!-- Include Select2 CSS and JS files -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

  
<script>
    $(document).ready(function () {
        var table = $('#datatable').DataTable({
            responsive: true,
            initComplete: function () {
                this.api().columns().every(function () {
                    var column = this;
                    if (
                        column.index() === 5 || // Customer Name
                        column.index() === 4 || // Rep Name
                        column.index() === 6 || // CATEGORY
                        column.index() === 11 // Pi Status
                    ) {
                        var select = $('<select class="select2"><option value=""></option></select>')
                            .appendTo($(column.header()))
                            .on('change', function () {
                                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                column.search(val ? '^' + val + '$' : '', true, false).draw();
                            });

                        select.append('<option value="">All</option>');

                        column.data().unique().sort().each(function (d, j) {
                            var displayedValue = d.length > 15 ? d.substr(0, 15) + '...' : d;
                            select.append('<option value="' + d + '">' + displayedValue + '</option>');
                        });

                        select.select2();
                    }
                });
            }
        }).on('draw.dt', function () {
            // Add resizing functionality to columns after each draw
            table.columns().every(function () {
                new $.fn.dataTable.Responsive.ColumnResize(this, {
                    resizeCallback: function (column) {
                        var tableApi = this.s.dt;
                        tableApi.table().node().style.width = 'auto';
                        tableApi.columns.adjust();
                    }
                });
            });
        });

        $('#datatable thead').on('click', 'th', function () {
            $(this).find('input, select').focus();
        });
    });
</script>


    @*<script>
        $(document).ready(function () {
            var table = $('#datatable').DataTable({
                responsive: true,
                initComplete: function () {
                    this.api().columns().every(function () {
                        var column = this;
                        if (
                            column.index() === 5 || // Customer Name
                            column.index() === 4 || // Rep Name
                            column.index() === 6 || // CATEGORY
                            column.index() === 11 // Pi Status
                        ) {
                            var select = $('<select class="select2"><option value=""></option></select>')
                                .appendTo($(column.header()))
                                .on('change', function () {
                                    var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                    column.search(val ? '^' + val + '$' : '', true, false).draw();
                                });

                            select.append('<option value="">All</option>');

                            column.data().unique().sort().each(function (d, j) {
                                var displayedValue = d.length > 15 ? d.substr(0, 15) + '...' : d;
                                var columnHeaderText = $(column.header()).text(); // Get the column header text
                                select.append('<option value="' + d + '">' + columnHeaderText + ': ' + displayedValue + '</option>');
                            });

                            select.select2();
                        }
                    });
                },
                drawCallback: function () {
                    // Update the dropdown button text with the selected value
                    $('.select2').each(function () {
                        var selectedValue = $(this).val();
                        var buttonText = $(this).find('option[value="' + selectedValue + '"]').text();
                        $(this).siblings('.select2-container').find('.select2-selection__rendered').text(buttonText);
                    });
                }
            }).on('draw.dt', function () {
                // Add resizing functionality to columns after each draw
                table.columns().every(function () {
                    new $.fn.dataTable.Responsive.ColumnResize(this, {
                        resizeCallback: function (column) {
                            var tableApi = this.s.dt;
                            tableApi.table().node().style.width = 'auto';
                            tableApi.columns.adjust();
                        }
                    });
                });
            });

            $('#datatable thead').on('click', 'th', function () {
                $(this).find('input, select').focus();
            });
        });

    </script>*@

    <script>
        var apiDataList = [];
        $(document).ready(function () {
           
            function updateTotalValue() {
                var totalValue = 0.00;
                $(apiDataList).each(function () {
                    totalValue += Number(this.DelValue);
                });
                $('#total-value').html(totalValue.toFixed(2));
                console.log('totalValue',totalValue);
            }
            $('#datatable').DataTable();
            $('#submit-btn').on('click', function () {
                if(apiDataList.length===0) return 

                $.post("@Url.Action("SaveApiData", "Sales")", { apiDataList: apiDataList }, function (result) {
                    apiDataList = []
                    if (result) {
                        //console.log(result)
                        //console.log(result);
                        if (result > 0) {
                            Swal.fire(
                                'Success!',
                                'Save Successful',
                                'success'
                            );
                        }
                        } else {
                            Swal.fire(
                                'Failed!',
                                'Failed To Do the operation',
                                'danger'
                        );
                        console.log("success")
                       
                    }
                    $('#added-table tbody').empty()
                    updateTotalValue();
                    $(".selected").prop("checked", false)
                });
            });
            $('#advise_btn').on('click', function () {
                @*window.open('@Url.Action("BondApprovedPi", "Sales")', '_blank');*@
                let bookings = []
                $('input[type=checkbox]').each(function () {
                    if ($(this).is(":checked")) {
                        bookings.push($(this).attr('data-booking-no'));
                    }
                });
                $.post("@Url.Action("LoadPiAdvisingDataPartial", "Sales")", { bookings: bookings }, function (result) {
                    if (result) {
                        //console.log(result)
                            //console.log(result);
                            $('.pi-modal-content').empty();
                            $('.pi-modal-content').html(result);
                            $('.pi-advise-modal').modal('show');
                        } else {
                            Swal.fire(
                                'Failed!',
                                'Failed To Do the operation',
                                'danger'
                            );
                        }
                });

            });
            //changes for search
            var table = $('#datatable').DataTable({
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                "order": [[1, "desc"]]


            });



            // Listen for change event on checkboxes in Table A
            $('#datatable').on('change', '.selected', function () {
                var $row = $(this).closest('tr');  // Get the parent row of the checkbox
                if ($(this).is(':checked')) {
                    // Add the row to Table B
                    apiDataList.push({
                        'BookingNo': $(this).closest('tr').find('.BookingNo').val(),
                        'InvoiceQty': Number($(this).closest('tr').find('.InvoiceQty').val()),
                        'DelValue': $(this).closest('tr').find('.DelValue').val()
                    });
                    $('#added-table tbody tr').addClass('custom-row-height');
                    //console.log(apiDataList);
                    updateTotalValue();

                    $('#added-table tbody').append($row.clone().find('.selected').remove().end());
                    $('#added-table tbody tr').addClass('custom-row-height');
                } else {
                    // Remove the row from Table B
                    console.log($(this).closest('tr').find('.BookingNo').val(), $(this).attr("data-booking-no"))
                    apiDataList = apiDataList.filter(el => el.BookingNo !== $(this).attr("data-booking-no"));
                    var bookingNo = $row.find('.selected').data('booking-no');
                    $('#added-table tbody').find('tr:contains(' + bookingNo + ')').remove();
                    updateTotalValue();
                }
            });


            //// Listen for change event on checkboxes in Table A
            //$('#datatable').on('change', '.selected', function () {
            //    var $row = $(this).closest('tr');  // Get the parent row of the checkbox
            //    if ($(this).is(':checked')) {
            //        // Add the row to Table B
            //        var bookingNo = $row.find('.text-left.td-green:nth-child(2)').text().trim();
            //        var customerName = $row.find('.text-left.td-green:nth-child(6)').text().trim();
            //        var bookingQty = $row.find('.text-left.td-green:nth-child(8)').text().trim();
            //        var delValue = $row.find('.text-left.td-green:nth-child(9)').text().trim();
            //        var piStatus = $row.find('.text-center.td-green:last').text().trim();

            //        apiDataList.push({
            //            'BookingNo': bookingNo,
            //            'CustomerName': customerName,
            //            'BookingQty': bookingQty,
            //            'DelValue': $(this).closest('tr').find('.DelValue').val(),
            //            'PiStatus': piStatus
            //        });

            //        var totalValue = parseFloat($('#total-value').text());
            //        totalValue += parseFloat(delValue);
            //        $('#total-value').text(totalValue.toFixed(2));

            //        $('#added-table tbody tr').addClass('custom-row-height');

            //        var clonedRow = $('<tr></tr>');
            //        clonedRow.append('<td>' + bookingNo + '</td>');
            //        clonedRow.append('<td>' + customerName + '</td>');
            //        clonedRow.append('<td>' + bookingQty + '</td>');
            //        clonedRow.append('<td>' + bookingValue + '</td>');
            //        clonedRow.append('<td>' + piStatus + '</td>');

            //        $('#added-table tbody').append(clonedRow);
            //        $('#added-table tbody tr').addClass('custom-row-height');
            //    } else {
            //        // Remove the row from Table B
            //        var bookingNo = $(this).attr("data-booking-no");
            //        apiDataList = apiDataList.filter(el => el.BookingNo !== bookingNo);
            //        var bookingNoRow = $('#added-table tbody').find('tr:contains(' + bookingNo + ')');
            //        var bookingValue = bookingNoRow.find('td:nth-child(4)').text().trim();
            //        var totalValue = parseFloat($('#total-value').text());
            //        totalValue -= parseFloat(bookingValue);
            //        $('#total-value').text(totalValue.toFixed(2));
            //        bookingNoRow.remove();
            //    }
            //});



           
            updateTotalValue();
            $('#added-bookings-table').on('change', '.booking-select', function () {
                updateTotalValue();
            });

            // Select All button click event handler
            $('#select-all-btn').on('click', function () {
                $('#datatable').find('.selected').prop('checked', true).trigger('change');
            });

            // Clear All button click event handler
            $('#clear-all-btn').on('click', function () {
                $('#datatable').find('.selected').prop('checked', false).trigger('change');
            });
        });</script>
}